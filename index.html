<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title id="pageTitle">多國語言即時逐字稿工具</title>
    <style>
        /* ... 您的原有 CSS ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            padding: 20px;
        }
        #uiLangToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        #uiLangToggle:hover { 
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        h1 { 
            color: white;
            margin: 60px 0 30px 0;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .transcript-container {
            width: 90%;
            max-width: 900px;
            height: 45vh;
            margin-bottom: 20px;
            border: none;
            border-radius: 16px;
            background-color: #fff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow-y: scroll;
            padding: 20px;
        }
        #transcript {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 16px;
            line-height: 1.8;
            margin: 0;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            color: #333;
        }
        .interim { color: #888; font-style: italic; }
        .placeholder { color: #999; }
        .volume-meter {
            width: 90%;
            max-width: 900px;
            height: 24px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        .volume-level {
            height: 100%; 
            width: 0%; 
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.1s ease-out;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .settings {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.15);
            padding: 15px 25px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        #lang-label {
            color: white;
            font-weight: 600;
            font-size: 15px;
        }
        #languageSelector {
            padding: 10px 15px;
            font-size: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        #languageSelector:hover {
            background: white;
            border-color: rgba(255, 255, 255, 0.5);
        }
        .controls { 
            display: flex; 
            flex-direction: column;
            gap: 15px; 
            margin-bottom: 20px;
            align-items: center;
        }
        .button-row {
            display: flex;
            gap: 15px;
        }
        button {
            padding: 14px 30px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            color: white;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:active {
            transform: translateY(2px);
        }
        button:disabled { 
            background: linear-gradient(135deg, #9E9E9E 0%, #BDBDBD 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }
        #controlBtn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
            min-width: 160px;
        }
        #controlBtn:hover { 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        #controlBtn.listening::after {
            content: '●';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff4444;
            font-size: 20px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        #exportBtn { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        #exportBtn:hover:not(:disabled) { 
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
            transform: translateY(-2px);
        }
        
        /* [新增] 複製按鈕樣式 */
        #copyBtn {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        #copyBtn:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(253, 160, 133, 0.4);
            transform: translateY(-2px);
        }
        
        .warning-notice {
            background: rgba(255, 193, 7, 0.95);
            color: #000;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            max-width: 600px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 2px solid rgba(255, 152, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .warning-notice::before {
            content: '⚠️';
            font-size: 18px;
        }

        .privacy-notice {
            width: 90%;
            max-width: 900px;
            font-size: 14px;
            margin-top: auto;
            margin-bottom: 20px;
        }
        .privacy-notice details {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }
        .privacy-notice summary {
            padding: 15px 20px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            color: white;
            font-size: 15px;
        }
        .privacy-notice summary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .privacy-notice .content {
            padding: 0 20px 20px 20px;
            line-height: 1.6;
            color: white;
        }
        .privacy-notice h3 {
            margin-top: 15px;
            margin-bottom: 8px;
            color: #FFD54F;
        }
        .privacy-notice ul {
            padding-left: 20px;
            margin: 0;
        }
        .privacy-notice ul li {
            margin-bottom: 8px;
        }
        .privacy-notice ul li.safe::before { content: '✅ '; }
        .privacy-notice ul li.unsafe::before { content: '❌ '; }
        .privacy-notice strong { 
            color: #FF6B6B;
            font-weight: 700;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 22px; margin: 50px 20px 20px 20px; }
            .transcript-container { height: 40vh; }
            .button-row { flex-direction: column; width: 100%; }
            button { width: 100%; }
            .settings { flex-direction: column; width: 90%; }
        }
    </style>
</head>
<body>
    <button id="uiLangToggle" title="Switch the user interface language">Switch to English</button>

    <h1 id="main-title">多國語言即時逐字稿工具</h1>
    
    <div class="transcript-container" id="transcriptContainer">
        <pre id="transcript"><span class="placeholder" id="placeholder-text"></span></pre>
    </div>
    
    <div class="volume-meter">
        <div class="volume-level" id="volumeLevel"></div>
    </div>

    <div class="settings">
        <label for="languageSelector" id="lang-label">辨識語言:</label>
        <select id="languageSelector" title="選擇要進行辨識的語言">
            <option value="en-US">English (US)</option>
            <option value="en-GB">English (UK)</option>
            <option value="zh-TW">中文 (台灣TW)</option>
            <option value="zh-CN">中文 (中国大陆CN)</option>
            <option value="zh-HK">粵語 (香港HK)</option>
            <option value="ja-JP">日本語(JP)</option>
            <option value="ko-KR">한국어(KR)</option>
            <option value="es-ES">Español (España)</option>
            <option value="fr-FR">Français</option>
            <option value="de-DE">Deutsch</option>
        </select>
    </div>
    
    <div class="controls">
        <div class="button-row">
            <button id="controlBtn" title="點擊以開始語音辨識">開始辨識</button>
            <!-- [新增] 複製按鈕 -->
            <button id="copyBtn" disabled title="停止辨識後才能複製">複製內容</button>
            <button id="exportBtn" disabled title="停止辨識後才能匯出">輸出逐字稿</button>
        </div>
        <div class="warning-notice" id="warning-text">
            本工具將把收到音檔上傳 Google 請謹慎使用
        </div>
    </div>

    <div class="privacy-notice">
        <details>
            <summary id="privacy-summary">使用須知 & 隱私聲明</summary>
            <div class="content">
                <p id="how-it-works-text"></p>
                <h3 id="suitable-scenarios-title"></h3>
                <ul id="suitable-scenarios-list"></ul>
                <h3 id="risk-scenarios-title"></h3>
                <ul id="risk-scenarios-list"></ul>
                <p id="privacy-conclusion"></p>
            </div>
        </details>
    </div>

    <script>
    // 使用 IIFE (立即調用函式表達式) 避免污染全域作用域
    (function() {
        // [優化] 集中管理所有 DOM 元素
        const UIElements = {
            pageTitle: document.getElementById('pageTitle'),
            mainTitle: document.getElementById('main-title'),
            transcript: document.getElementById('transcript'),
            transcriptContainer: document.getElementById('transcriptContainer'),
            controlBtn: document.getElementById('controlBtn'),
            exportBtn: document.getElementById('exportBtn'),
            copyBtn: document.getElementById('copyBtn'),
            volumeLevel: document.getElementById('volumeLevel'),
            languageSelector: document.getElementById('languageSelector'),
            langLabel: document.getElementById('lang-label'),
            uiLangToggle: document.getElementById('uiLangToggle'),
            placeholderText: document.getElementById('placeholder-text'),
            warningText: document.getElementById('warning-text'),
            privacySummary: document.getElementById('privacy-summary'),
            howItWorksText: document.getElementById('how-it-works-text'),
            suitableScenariosTitle: document.getElementById('suitable-scenarios-title'),
            suitableScenariosList: document.getElementById('suitable-scenarios-list'),
            riskScenariosTitle: document.getElementById('risk-scenarios-title'),
            riskScenariosList: document.getElementById('risk-scenarios-list'),
            privacyConclusion: document.getElementById('privacy-conclusion'),
        };

        // 多國語言翻譯內容 (保持不變)
        const translations = {
            en: {
                pageTitle: "Multilingual Real-time Transcription Tool",
                mainTitle: "Multilingual Real-time Transcription Tool",
                langLabel: "Recognition Language:",
                startBtn: "Start Recognition",
                stopBtn: "Stop Recognition",
                exportBtn: "Export Transcript",
                copyBtn: "Copy Transcript",
                toggleUiLangBtn: "切换到中文",
                placeholder: "Click 'Start Recognition' and your transcript will appear here...",
                micDeniedError: "You have denied microphone access. Please allow microphone access to use this feature.",
                apiNotSupportedError: "Your browser does not support the Web Speech API. Please use the latest version of Chrome.",
                controlBtnTooltipStart: "Click to start voice recognition",
                controlBtnTooltipStop: "Click to stop voice recognition",
                exportBtnTooltip: "Export the transcript as a .txt file",
                exportBtnTooltipDisabled: "Stop recognition to enable export",
                copyBtnTooltip: "Copy the transcript to your clipboard",
                copyBtnTooltipDisabled: "Stop recognition to enable copy",
                languageSelectorTooltip: "Select the language to be recognized",
                uiLangToggleTooltip: "Switch the user interface language",
                warningText: "This tool uploads audio to Google. Use with caution.",
                copiedSuccess: "Copied to clipboard!",
                copiedError: "Copy failed. Please try again.",
                privacySummary: "Usage Guide & Privacy Notice",
                howItWorksText: "To convert speech to text, this tool uses the browser's built-in Web Speech API, which sends your voice data to Google's servers for processing. Please be aware of the following:",
                suitableScenariosTitle: "Suitable Scenarios:",
                suitableScenarios: ["Assisting in listening to public online lectures, webinars, or courses.", "Transcribing public content like videos or podcasts.", "Personal learning and language practice."],
                riskScenariosTitle: "High-Risk Scenarios (DO NOT USE):",
                riskScenarios: ["Meetings involving <strong>business secrets</strong> or confidential information.", "Conversations involving <strong>personal privacy</strong> (e.g., with doctors, lawyers).", "Any content containing <strong>sensitive personal data</strong> (ID numbers, passwords, etc.)."],
                privacyConclusion: "For sensitive content, it is strongly recommended to use offline tools like Whisper that process data entirely on your local machine."
            },
            zh: {
                pageTitle: "多國語言即時逐字稿工具",
                mainTitle: "多國語言即時逐字稿工具",
                langLabel: "辨識語言:",
                startBtn: "開始辨識",
                stopBtn: "停止辨識",
                exportBtn: "輸出逐字稿",
                copyBtn: "複製內容",
                toggleUiLangBtn: "Switch to English",
                placeholder: "點擊「開始辨識」後,你的逐字稿將會顯示在這裡...",
                micDeniedError: "您拒絕了麥克風權限。請允許麥克風存取以使用此功能。",
                apiNotSupportedError: "您的瀏覽器不支援 Web Speech API,請使用最新版本的 Chrome 瀏覽器。",
                controlBtnTooltipStart: "點擊以開始語音辨識",
                controlBtnTooltipStop: "點擊以停止語音辨識",
                exportBtnTooltip: "將逐字稿匯出為 .txt 檔案",
                exportBtnTooltipDisabled: "停止辨識後才能匯出",
                copyBtnTooltip: "將逐字稿複製到剪貼簿",
                copyBtnTooltipDisabled: "停止辨識後才能複製",
                languageSelectorTooltip: "選擇要進行辨識的語言",
                uiLangToggleTooltip: "切換使用者介面語言",
                warningText: "本工具將把收到音檔上傳 Google 請謹慎使用",
                copiedSuccess: "已複製到剪貼簿！",
                copiedError: "複製失敗，請重試。",
                privacySummary: "使用須知 & 隱私聲明",
                howItWorksText: "本工具透過瀏覽器內建的 Web Speech API 進行語音轉文字,這會將您的聲音資料傳送到 Google 的伺服器進行處理。請務必了解以下事項：",
                suitableScenariosTitle: "適合的使用場景：",
                suitableScenarios: ["輔助聆聽公開的線上演講、課程。", "轉錄影片、Podcast 等公開內容。", "個人學習、語言練習。"],
                riskScenariosTitle: "高風險場景 (絕對不要使用)：",
                riskScenarios: ["任何涉及<strong>商業機密</strong>或公司內部資訊的會議。", "任何涉及<strong>個人隱私</strong>的對話 (例如與醫生、律師的對話)。", "任何包含<strong>敏感個資</strong>的內容 (如身分證號、密碼等)。"],
                privacyConclusion: "針對敏感內容,強烈建議使用像 Whisper 這樣完全在您本機離線運作的工具,以確保資料安全。"
            }
        };

        // [優化] 集中管理應用程式狀態
        const state = {
            currentUiLang: 'zh',
            startTime: null,
            endTime: null,
            transcriptSegments: [],
            isRecognizing: false,
            interimTranscript: '',
            isManualStop: false,
            recognition: null,
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            restartTimeout: null,
            recognitionActive: false,
        };
        
        // 音量條的獨立狀態管理
        const audioState = {
            context: null,
            stream: null,
            analyser: null,
            animationFrameId: null,
        };
        
        /**
         * 初始化應用程式
         */
        function init() {
            loadPreferences();
            setupEventListeners();
            initSpeechRecognition();
            setUiLanguage(state.currentUiLang);
        }

        /**
         * 統一設定所有事件監聽器
         */
        function setupEventListeners() {
            UIElements.uiLangToggle.addEventListener('click', toggleUiLanguage);
            UIElements.controlBtn.addEventListener('click', toggleRecognition);
            UIElements.exportBtn.addEventListener('click', exportTranscript);
            UIElements.copyBtn.addEventListener('click', copyTranscript);
            UIElements.languageSelector.addEventListener('change', () => {
                if (state.recognition) {
                    state.recognition.lang = UIElements.languageSelector.value;
                }
                savePreferences();
            });
        }

        /**
         * 初始化 Web Speech API 辨識引擎
         */
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert(translations.en.apiNotSupportedError);
                UIElements.controlBtn.disabled = true;
                return;
            }
            state.recognition = new webkitSpeechRecognition();
            state.recognition.continuous = !state.isMobile;
            state.recognition.interimResults = true;
            state.recognition.maxAlternatives = 1;
            
            state.recognition.onstart = handleRecognitionStart;
            state.recognition.onerror = handleRecognitionError;
            state.recognition.onend = handleRecognitionEnd;
            state.recognition.onresult = handleRecognitionResult;
        }

        /**
         * 切換 UI 語言
         */
        function toggleUiLanguage() {
            const newLang = state.currentUiLang === 'zh' ? 'en' : 'zh';
            setUiLanguage(newLang);
            savePreferences();
        }

        /**
         * 根據指定語言更新所有 UI 文字
         * @param {string} lang - 'en' 或 'zh'
         */
        function setUiLanguage(lang) {
            state.currentUiLang = lang;
            const t = translations[lang];
            
            UIElements.pageTitle.textContent = t.pageTitle;
            UIElements.mainTitle.textContent = t.mainTitle;
            UIElements.langLabel.textContent = t.langLabel;
            UIElements.exportBtn.textContent = t.exportBtn;
            UIElements.copyBtn.textContent = t.copyBtn;
            UIElements.uiLangToggle.textContent = t.toggleUiLangBtn;
            UIElements.placeholderText.textContent = t.placeholder;
            UIElements.uiLangToggle.title = t.uiLangToggleTooltip;
            UIElements.languageSelector.title = t.languageSelectorTooltip;
            UIElements.warningText.textContent = t.warningText;
            
            UIElements.privacySummary.textContent = t.privacySummary;
            UIElements.howItWorksText.textContent = t.howItWorksText;
            UIElements.suitableScenariosTitle.textContent = t.suitableScenariosTitle;
            UIElements.riskScenariosTitle.textContent = t.riskScenariosTitle;
            UIElements.privacyConclusion.innerHTML = t.privacyConclusion;

            UIElements.suitableScenariosList.innerHTML = t.suitableScenarios.map(item => `<li class="safe">${item}</li>`).join('');
            UIElements.riskScenariosList.innerHTML = t.riskScenarios.map(item => `<li class="unsafe">${item}</li>`).join('');

            updateButtonStates();
        }
        
        /**
         * 更新所有按鈕的狀態 (文字、啟用/禁用、提示)
         */
        function updateButtonStates() {
            const t = translations[state.currentUiLang];
            UIElements.controlBtn.textContent = state.isRecognizing ? t.stopBtn : t.startBtn;
            UIElements.controlBtn.title = state.isRecognizing ? t.controlBtnTooltipStop : t.controlBtnTooltipStart;
            UIElements.controlBtn.classList.toggle('listening', state.isRecognizing);
            
            const canExportOrCopy = !state.isRecognizing && state.transcriptSegments.length > 1;
            UIElements.exportBtn.disabled = !canExportOrCopy;
            UIElements.copyBtn.disabled = !canExportOrCopy;
            
            UIElements.exportBtn.title = canExportOrCopy ? t.exportBtnTooltip : t.exportBtnTooltipDisabled;
            UIElements.copyBtn.title = canExportOrCopy ? t.copyBtnTooltip : t.copyBtnTooltipDisabled;
        }

        /**
         * 開始或停止語音辨識
         */
        function toggleRecognition() {
            if (state.isRecognizing) {
                stopRecognition();
            } else {
                startRecognition();
            }
        }
        
        /**
         * 開始語音辨識
         */
        function startRecognition() {
            state.isManualStop = false;
            state.recognition.lang = UIElements.languageSelector.value;
            state.startTime = new Date();
            state.transcriptSegments = [{ timestamp: state.startTime, text: '--- Recording Start / 錄音開始 ---' }];
            state.interimTranscript = '';
            
            updateTranscriptDisplay();
            
            if (!state.isMobile) {
                setTimeout(() => startAudioMeter().catch(err => console.warn("Could not start audio meter:", err)), 300);
            }
            
            try {
                if (!state.recognitionActive) state.recognition.start();
            } catch (e) {
                console.error("Error starting recognition:", e);
                alert("無法啟動語音辨識，請重新整理頁面再試。\nFailed to start recognition, please refresh and try again.");
            }
        }

        /**
         * 手動停止語音辨識
         */
        function stopRecognition() {
            state.isManualStop = true;
            if (state.recognitionActive) {
                state.recognition.stop();
            } else {
                // 如果辨識引擎已自行停止但狀態未更新，手動觸發結束流程
                handleRecognitionEnd();
            }
        }

        // --- SpeechRecognition 事件處理函式 ---

        function handleRecognitionStart() {
            state.recognitionActive = true;
            state.isRecognizing = true;
            UIElements.languageSelector.disabled = true;
            updateButtonStates();
            console.log('✅ Recognition started successfully');
        }

        function handleRecognitionError(event) {
            console.error('Speech Recognition Error:', event.error, event);
            state.recognitionActive = false;
            if (event.error === 'not-allowed') {
                alert(translations[state.currentUiLang].micDeniedError);
            } else if (event.error === 'no-speech') {
                console.log('No speech detected, will retry...');
            } else if (event.error === 'network') {
                alert('網路連線問題,請檢查網路設定。\nNetwork error, please check your connection.');
            }
        }

        function handleRecognitionEnd() {
            state.recognitionActive = false;
            clearTimeout(state.restartTimeout);

            if (!state.isManualStop && state.isRecognizing) {
                const restartDelay = state.isMobile ? 200 : 500;
                state.restartTimeout = setTimeout(() => {
                    if (state.isRecognizing && !state.recognitionActive) {
                        try {
                            state.recognition.start();
                            console.log('Auto-restarting recognition');
                        } catch (e) {
                            console.error('Failed to auto-restart:', e);
                        }
                    }
                }, restartDelay);
            } else {
                state.isRecognizing = false;
                UIElements.languageSelector.disabled = false;
                state.endTime = new Date();
                updateButtonStates();
                stopAudioMeter();
            }
        }

        function handleRecognitionResult(event) {
            state.interimTranscript = '';
            let final_transcript_this_turn = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    final_transcript_this_turn += transcript.trim() + ' ';
                } else {
                    state.interimTranscript += transcript;
                }
            }

            if (final_transcript_this_turn) {
                state.transcriptSegments.push({ timestamp: new Date(), text: final_transcript_this_turn.trim() });
            }

            updateTranscriptDisplay();
        }
        
        // --- 逐字稿顯示與檔案處理 ---

        function updateTranscriptDisplay() {
            const finalContent = state.transcriptSegments.map(segment => `${formatTime(segment.timestamp)} ${segment.text}`).join('\n');
            UIElements.transcript.innerHTML = `<span class="placeholder" id="placeholder-text" style="display:none;"></span>${finalContent}\n<span class="interim">${state.interimTranscript}</span>`;
            UIElements.transcriptContainer.scrollTop = UIElements.transcriptContainer.scrollHeight;
        }

        function getFullTranscriptText() {
            return state.transcriptSegments.map(segment => `${formatTime(segment.timestamp)} ${segment.text}`).join('\n');
        }

        function exportTranscript() {
            if (!state.startTime || !state.endTime) return;
            const textToSave = getFullTranscriptText().replace(/\n/g, '\r\n');
            const fileName = createFileName(state.startTime, state.endTime);
            const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        function copyTranscript() {
            if (state.transcriptSegments.length <= 1) return;

            const textToCopy = getFullTranscriptText();
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert(translations[state.currentUiLang].copiedSuccess);
            }, (err) => {
                console.error('Could not copy text: ', err);
                alert(translations[state.currentUiLang].copiedError);
            });
        }
        
        // --- 使用者偏好設定 (localStorage) ---
        function savePreferences() {
            localStorage.setItem('stt_ui_lang', state.currentUiLang);
            localStorage.setItem('stt_rec_lang', UIElements.languageSelector.value);
        }

        function loadPreferences() {
            const savedUiLang = localStorage.getItem('stt_ui_lang');
            const savedRecLang = localStorage.getItem('stt_rec_lang');
            const browserLang = navigator.language || navigator.userLanguage;
            
            // 優先載入儲存的設定，若無則根據瀏覽器語言判斷
            state.currentUiLang = savedUiLang || (browserLang.startsWith('zh') ? 'zh' : 'en');
            
            if (savedRecLang) {
                UIElements.languageSelector.value = savedRecLang;
            }
        }

        // --- 音量條相關函式 ---
        async function startAudioMeter() {
            if (!navigator.mediaDevices?.getUserMedia) return Promise.reject('getUserMedia not supported');
            if(audioState.context) return; // 避免重複啟動
            
            audioState.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioState.context = new (window.AudioContext || window.webkitAudioContext)();
            audioState.analyser = audioState.context.createAnalyser();
            const source = audioState.context.createMediaStreamSource(audioState.stream);
            source.connect(audioState.analyser);
            drawVolume();
        }

        function stopAudioMeter() {
            if (audioState.animationFrameId) cancelAnimationFrame(audioState.animationFrameId);
            audioState.stream?.getTracks().forEach(track => track.stop());
            if (audioState.context?.state !== 'closed') {
                audioState.context.close().then(() => audioState.context = null);
            }
            UIElements.volumeLevel.style.width = '0%';
        }

        function drawVolume() {
            const dataArray = new Uint8Array(audioState.analyser.frequencyBinCount);
            audioState.analyser.getByteTimeDomainData(dataArray);
            let sumSquares = 0.0;
            for (const amplitude of dataArray) {
                const a = (amplitude / 128.0) - 1.0;
                sumSquares += a * a;
            }
            const rms = Math.sqrt(sumSquares / dataArray.length);
            const volume = Math.min(100, rms * 100 * 10);
            UIElements.volumeLevel.style.width = volume + '%';
            audioState.animationFrameId = requestAnimationFrame(drawVolume);
        }

        // --- 工具函式 ---
        function formatTime(date) {
            const h = formatTwoDigits(date.getHours());
            const m = formatTwoDigits(date.getMinutes());
            const s = formatTwoDigits(date.getSeconds());
            return `[${h}:${m}:${s}]`;
        }

        function formatTwoDigits(n) {
            return n < 10 ? '0' + n : String(n);
        }

        function createFileName(start, end) {
            const date = `${start.getFullYear()}-${formatTwoDigits(start.getMonth() + 1)}-${formatTwoDigits(start.getDate())}`;
            const startTimeStr = `${formatTwoDigits(start.getHours())}-${formatTwoDigits(start.getMinutes())}-${formatTwoDigits(start.getSeconds())}`;
            const endTimeStr = `${formatTwoDigits(end.getHours())}-${formatTwoDigits(end.getMinutes())}-${formatTwoDigits(end.getSeconds())}`;
            return `transcript_${date}_${startTimeStr}_to_${endTimeStr}.txt`;
        }

        // 應用程式進入點
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
