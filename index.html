<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 修正：告訴瀏覽器沒有 favicon，避免 404 錯誤 -->
    <link rel="icon" href="data:,">
    <title id="pageTitle">多國語言即時逐字稿工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            position: relative;
        }
        #uiLangToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        #uiLangToggle:hover { background-color: #5a6268; }
        h1 { color: #333; }
        .transcript-container {
            width: 80%;
            max-width: 800px;
            height: 45vh;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: scroll;
            padding: 15px;
        }
        #transcript {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 16px;
            line-height: 1.6;
            margin: 0;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        }
        .interim { color: #888; }
        .placeholder { color: #999; }
        .volume-meter {
            width: 80%;
            max-width: 800px;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid #ccc;
        }
        .volume-level {
            height: 100%; width: 0%; background-color: #4CAF50;
            transition: width 0.1s ease-out;
        }
        .settings {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        #languageSelector {
            padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;
        }
        .controls { display: flex; gap: 15px; }
        button {
            padding: 12px 25px; font-size: 16px; cursor: pointer; border: none;
            border-radius: 5px; color: white; transition: background-color 0.3s ease;
        }
        #controlBtn { background-color: #007bff; }
        #controlBtn:hover { background-color: #0056b3; }
        #exportBtn { background-color: #28a745; }
        #exportBtn:hover { background-color: #218838; }
        #exportBtn:disabled { background-color: #9E9E9E; cursor: not-allowed; }
    </style>
</head>
<body>
    <button id="uiLangToggle" title="Switch the user interface language">Switch to English</button>

    <h1 id="main-title">多國語言即時逐字稿工具</h1>
    
    <div class="transcript-container" id="transcriptContainer">
        <pre id="transcript"><span class="placeholder" id="placeholder-text"></span></pre>
    </div>
    
    <div class="volume-meter">
        <div class="volume-level" id="volumeLevel"></div>
    </div>

    <div class="settings">
        <label for="languageSelector" id="lang-label">辨識語言:</label>
        <select id="languageSelector" title="Select the language to be recognized">
            <option value="en-US">English (US)</option>
            <option value="en-GB">English (UK)</option>
            <option value="cmn-Hant-TW">中文 (台灣)</option>
            <option value="cmn-Hans-CN">中文 (中国大陆)</option>
            <option value="yue-Hant-HK">粵語 (香港)</option>
            <option value="ja-JP">日本語</option>
            <option value="ko-KR">한국어</option>
            <option value="es-ES">Español (España)</option>
            <option value="fr-FR">Français</option>
            <option value="de-DE">Deutsch</option>
        </select>
    </div>
    
    <div class="controls">
        <button id="controlBtn" title="點擊以開始語音辨識">開始辨識</button>
        <button id="exportBtn" disabled title="停止辨識後才能匯出">輸出逐字稿</button>
    </div>

    <script>
        // --- DOM Elements ---
        const pageTitle = document.getElementById('pageTitle');
        const mainTitle = document.getElementById('main-title');
        const transcriptElement = document.getElementById('transcript');
        const transcriptContainer = document.getElementById('transcriptContainer');
        const controlBtn = document.getElementById('controlBtn');
        const exportBtn = document.getElementById('exportBtn');
        const volumeLevel = document.getElementById('volumeLevel');
        const languageSelector = document.getElementById('languageSelector');
        const langLabel = document.getElementById('lang-label');
        const uiLangToggle = document.getElementById('uiLangToggle');
        const placeholderText = document.getElementById('placeholder-text');

        // --- Translation Object with Tooltips ---
        const translations = {
            en: {
                pageTitle: "Multilingual Real-time Transcription Tool",
                mainTitle: "Multilingual Real-time Transcription Tool",
                langLabel: "Recognition Language:",
                startBtn: "Start Recognition",
                stopBtn: "Stop Recognition",
                exportBtn: "Export Transcript",
                toggleUiLangBtn: "切换到中文",
                placeholder: "Click 'Start Recognition' and your transcript will appear here...",
                micDeniedError: "You have denied microphone access. Please allow microphone access to use this feature.",
                apiNotSupportedError: "Your browser does not support the Web Speech API. Please use the latest version of Chrome.",
                controlBtnTooltipStart: "Click to start voice recognition",
                controlBtnTooltipStop: "Click to stop voice recognition",
                exportBtnTooltip: "Export the transcript as a .txt file",
                exportBtnTooltipDisabled: "Stop recognition to enable export",
                languageSelectorTooltip: "Select the language to be recognized",
                uiLangToggleTooltip: "Switch the user interface language"
            },
            zh: {
                pageTitle: "多國語言即時逐字稿工具",
                mainTitle: "多國語言即時逐字稿工具",
                langLabel: "辨識語言:",
                startBtn: "開始辨識",
                stopBtn: "停止辨識",
                exportBtn: "輸出逐字稿",
                toggleUiLangBtn: "Switch to English",
                placeholder: "點擊「開始辨識」後，你的逐字稿將會顯示在這裡...",
                micDeniedError: "您拒絕了麥克風權限。請允許麥克風存取以使用此功能。",
                apiNotSupportedError: "您的瀏覽器不支援 Web Speech API，請使用最新版本的 Chrome 瀏覽器。",
                controlBtnTooltipStart: "點擊以開始語音辨識",
                controlBtnTooltipStop: "點擊以停止語音辨識",
                exportBtnTooltip: "將逐字稿匯出為 .txt 檔案",
                exportBtnTooltipDisabled: "停止辨識後才能匯出",
                languageSelectorTooltip: "選擇要進行辨識的語言",
                uiLangToggleTooltip: "切換使用者介面語言"
            }
        };
        let currentUiLang = 'zh';

        // --- State Variables ---
        let startTime, endTime;
        let transcriptSegments = [];
        let isRecognizing = false;
        let interim_transcript = ''; // 修正：宣告在全域
        let audioContext, microphoneStream, analyser, animationFrameId;

        // --- UI Update Functions ---
        function setUiLanguage(lang) {
            currentUiLang = lang;
            const t = translations[lang];
            
            pageTitle.textContent = t.pageTitle;
            mainTitle.textContent = t.mainTitle;
            langLabel.textContent = t.langLabel;
            exportBtn.textContent = t.exportBtn;
            uiLangToggle.textContent = t.toggleUiLangBtn;
            placeholderText.textContent = t.placeholder;
            
            uiLangToggle.title = t.uiLangToggleTooltip;
            languageSelector.title = t.languageSelectorTooltip;

            updateButtonStates();
        }

        function updateButtonStates() {
            const t = translations[currentUiLang];
            controlBtn.textContent = isRecognizing ? t.stopBtn : t.startBtn;
            controlBtn.title = isRecognizing ? t.controlBtnTooltipStop : t.controlBtnTooltipStart;
            
            const canExport = !isRecognizing && transcriptSegments.length > 1;
            exportBtn.disabled = !canExport;
            exportBtn.title = canExport ? t.exportBtnTooltip : t.exportBtnTooltipDisabled;
        }

        uiLangToggle.addEventListener('click', () => {
            const newLang = currentUiLang === 'zh' ? 'en' : 'zh';
            setUiLanguage(newLang);
        });

        // --- Main Application Logic ---
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecognizing = true;
                languageSelector.disabled = true;
                startTime = new Date();
                transcriptSegments = [];
                interim_transcript = ''; // 修正：在開始時重置
                transcriptSegments.push({ timestamp: startTime, text: '--- Recording Start / 錄音開始 ---' });
                updateTranscriptDisplay();
                updateButtonStates();
            };

            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error);
                if (event.error === 'not-allowed') alert(translations[currentUiLang].micDeniedError);
                stopAudioMeter();
            };

            recognition.onend = () => {
                isRecognizing = false;
                languageSelector.disabled = false;
                endTime = new Date();
                updateButtonStates();
                stopAudioMeter();
            };

            recognition.onresult = (event) => {
                interim_transcript = ''; // 修正：在每次結果事件開始時清空
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        if (transcript.trim()) transcriptSegments.push({ timestamp: new Date(), text: transcript.trim() });
                    } else {
                        interim_transcript += transcript;
                    }
                }
                updateTranscriptDisplay();
            };
            
            function updateTranscriptDisplay() {
                const finalContent = transcriptSegments.map(segment => `${formatTime(segment.timestamp)} ${segment.text}`).join('\n');
                transcriptElement.innerHTML = `${finalContent}\n<span class="interim">${interim_transcript}</span>`;
                transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
            }

            controlBtn.addEventListener('click', () => {
                if (isRecognizing) {
                    recognition.stop();
                } else {
                    startAudioMeter().then(() => {
                        recognition.lang = languageSelector.value;
                        recognition.start();
                    }).catch(err => console.error("Could not start audio meter:", err));
                }
            });

            exportBtn.addEventListener('click', () => {
                if (!startTime || !endTime) return;
                const textToSave = transcriptSegments.map(segment => `${formatTime(segment.timestamp)} ${segment.text}`).join('\r\n');
                const fileName = createFileName(startTime, endTime);
                const blob = new Blob([textToSave], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            });

        } else {
            alert(translations.en.apiNotSupportedError);
        }

        // --- Utility Functions ---
        function formatTime(date) {
            const h = formatTwoDigits(date.getHours());
            const m = formatTwoDigits(date.getMinutes());
            const s = formatTwoDigits(date.getSeconds());
            return `[${h}:${m}:${s}]`;
        }

        async function startAudioMeter() {
            if (!navigator.mediaDevices?.getUserMedia) return Promise.reject('getUserMedia not supported');
            microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(microphoneStream);
            source.connect(analyser);
            drawVolume();
        }

        function stopAudioMeter() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            microphoneStream?.getTracks().forEach(track => track.stop());
            if (audioContext?.state !== 'closed') audioContext.close();
            volumeLevel.style.width = '0%';
        }

        function drawVolume() {
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(dataArray);
            let sumSquares = 0.0;
            for (const amplitude of dataArray) {
                const a = (amplitude / 128.0) - 1.0;
                sumSquares += a * a;
            }
            const rms = Math.sqrt(sumSquares / dataArray.length);
            const volume = Math.min(100, rms * 100 * 10);
            volumeLevel.style.width = volume + '%';
            animationFrameId = requestAnimationFrame(drawVolume);
        }

        function formatTwoDigits(n) { return n < 10 ? '0' + n : n; }
        
        function createFileName(start, end) {
            const date = `${start.getFullYear()}-${formatTwoDigits(start.getMonth() + 1)}-${formatTwoDigits(start.getDate())}`;
            const startTimeStr = `${formatTwoDigits(start.getHours())}-${formatTwoDigits(start.getMinutes())}-${formatTwoDigits(start.getSeconds())}`;
            const endTimeStr = `${formatTwoDigits(end.getHours())}-${formatTwoDigits(end.getMinutes())}-${formatTwoDigits(end.getSeconds())}`;
            return `${date}_${startTimeStr}_to_${endTimeStr}.txt`;
        }

        // --- Initialize UI ---
        document.addEventListener('DOMContentLoaded', () => {
            const browserLang = navigator.language || navigator.userLanguage;
            setUiLanguage(browserLang.startsWith('zh') ? 'zh' : 'en');
        });
    </script>
</body>
</html>
