<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title id="pageTitle">多國語言即時逐字稿工具</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; margin: 0; background-color: #f4f4f9; position: relative; padding: 20px 0; }
        #uiLangToggle { position: absolute; top: 20px; right: 20px; padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        h1 { color: #333; margin-top: 50px; text-align: center; }
        .transcript-container { width: 80%; max-width: 800px; height: 40vh; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-y: scroll; padding: 15px; }
        #transcript { white-space: pre-wrap; word-wrap: break-word; font-size: 16px; line-height: 1.6; margin: 0; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; }
        .segment { margin-bottom: 12px; }
        .original { display: block; }
        .translation { display: block; color: #007bff; font-style: italic; margin-top: 4px; padding-left: 15px; border-left: 2px solid #007bff; }
        .interim { color: #888; }
        .placeholder { color: #999; }
        .volume-meter { width: 80%; max-width: 800px; height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; margin-bottom: 15px; border: 1px solid #ccc; }
        .volume-level { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.1s ease-out; }
        .settings-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; align-items: center; margin-bottom: 15px; max-width: 800px; width: 80%; }
        .settings-grid label { justify-self: end; font-weight: bold; }
        .settings-grid input[type="checkbox"] { justify-self: start; }
        select, input { padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .controls { display: flex; gap: 15px; margin-bottom: 15px; }
        button { padding: 12px 25px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; transition: background-color 0.3s ease; }
        #controlBtn { background-color: #007bff; } #controlBtn:hover { background-color: #0056b3; }
        #exportBtn { background-color: #28a745; } #exportBtn:hover { background-color: #218838; }
        #exportBtn:disabled { background-color: #9E9E9E; cursor: not-allowed; }
        .privacy-notice { width: 80%; max-width: 800px; font-size: 14px; margin-top: auto; }
        .privacy-notice details { border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; }
        .privacy-notice summary { padding: 10px 15px; font-weight: bold; cursor: pointer; outline: none; }
        .privacy-notice .content { padding: 0 15px 15px 15px; line-height: 1.5; color: #333; }
        .privacy-notice h3 { margin-top: 15px; margin-bottom: 5px; }
        .privacy-notice ul { padding-left: 20px; margin: 0; }
        .privacy-notice ul li.safe::before { content: '✅ '; }
        .privacy-notice ul li.unsafe::before { content: '❌ '; }
        .privacy-notice strong { color: #d9534f; }
    </style>
</head>
<body>
    <button id="uiLangToggle" title="Switch UI language">English</button>
    <h1 id="main-title"></h1>
    <div class="transcript-container" id="transcriptContainer"><div id="transcript"><span class="placeholder" id="placeholder-text"></span></div></div>
    <div class="volume-meter"><div class="volume-level" id="volumeLevel"></div></div>

    <div class="settings-grid">
        <label for="languageSelector" id="lang-label"></label>
        <select id="languageSelector" title="Select recognition language"></select>
        <label for="translateCheckbox" id="translate-label"></label>
        <input type="checkbox" id="translateCheckbox">
        <label for="targetLangSelector" id="target-lang-label"></label>
        <select id="targetLangSelector" title="Select translation target language"></select>
    </div>
    
    <div class="controls">
        <button id="controlBtn"></button>
        <button id="exportBtn" disabled></button>
    </div>

    <div class="privacy-notice">
        <details><summary id="privacy-summary"></summary><div class="content" id="privacy-content"></div></details>
    </div>

    <script>
        // --- 這是您的 Google Apps Script 翻譯 API URL ---
        const SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'; // 如果您未使用翻譯功能，保留此樣即可

        // --- DOM Elements ---
        const pageTitle = document.getElementById('pageTitle'), mainTitle = document.getElementById('main-title'), transcriptElement = document.getElementById('transcript'), transcriptContainer = document.getElementById('transcriptContainer'), controlBtn = document.getElementById('controlBtn'), exportBtn = document.getElementById('exportBtn'), volumeLevel = document.getElementById('volumeLevel'), languageSelector = document.getElementById('languageSelector'), langLabel = document.getElementById('lang-label'), uiLangToggle = document.getElementById('uiLangToggle'), placeholderText = document.getElementById('placeholder-text'), translateCheckbox = document.getElementById('translateCheckbox'), targetLangSelector = document.getElementById('targetLangSelector'), translateLabel = document.getElementById('translate-label'), targetLangLabel = document.getElementById('target-lang-label'), privacySummary = document.getElementById('privacy-summary'), privacyContent = document.getElementById('privacy-content');

        // --- Language Options ---
        const recognitionLangs = { "en-US": "English (US)", "en-GB": "English (UK)", "cmn-Hant-TW": "中文 (台灣)", "cmn-Hans-CN": "中文 (中国大陆)", "yue-Hant-HK": "粵語 (香港)", "ja-JP": "日本語", "ko-KR": "한국어", "es-ES": "Español (España)", "fr-FR": "Français", "de-DE": "Deutsch" };
        const translationLangs = { "en": "English", "zh-TW": "中文 (繁體)", "zh-CN": "中文 (简体)", "ja": "日本語", "ko": "한국어", "es": "Español", "fr": "Français", "de": "Deutsch" };

        // --- Translation Object ---
        const translations = { /* ... (內容與之前相同，為節省空間省略) ... */ };
        let currentUiLang = 'zh';

        // --- State Variables ---
        let startTime, endTime, transcriptSegments = [], isRecognizing = false, isManualStop = false, audioContext, microphoneStream, analyser, animationFrameId;

        // --- UI Update Functions ---
        function setUiLanguage(lang) { /* ... (內容與之前相同，為節省空間省略) ... */ }
        function updateButtonStates() { /* ... (內容與之前相同，為節省空間省略) ... */ }
        uiLangToggle.addEventListener('click', () => { setUiLanguage(currentUiLang === 'zh' ? 'en' : 'zh'); });

        // --- Main Application Logic ---
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = true; recognition.interimResults = true;
            recognition.onstart = () => { isRecognizing = true; languageSelector.disabled = true; targetLangSelector.disabled = true; translateCheckbox.disabled = true; updateButtonStates(); console.log("Recognition started."); };
            recognition.onerror = (event) => { console.error('Speech Recognition Error:', event.error, event.message); if (event.error === 'not-allowed') alert(translations[currentUiLang].micDeniedError); };
            
            // --- 核心修正處 ---
            recognition.onend = () => {
                console.log("Recognition ended.");
                if (!isManualStop && isRecognizing) {
                    console.log("Attempting to restart recognition...");
                    // 使用 setTimeout 確保在下一個事件循環中重啟
                    setTimeout(() => {
                        if (isRecognizing) { // 再次檢查狀態，避免在手動停止後還重啟
                            recognition.start();
                        }
                    }, 100); // 100毫秒的延遲足夠且安全
                } else {
                    isRecognizing = false; languageSelector.disabled = false; targetLangSelector.disabled = false; translateCheckbox.disabled = false; endTime = new Date(); updateButtonStates(); stopAudioMeter();
                    console.log("Recognition stopped manually or session ended.");
                }
            };
            // --- 修正結束 ---

            recognition.onresult = async (event) => { /* ... (內容與之前相同，為節省空間省略) ... */ };
            async function translateText(text, segmentId) { /* ... (內容與之前相同，為節省空間省略) ... */ }
            function updateTranscriptDisplay() { /* ... (內容與之前相同，為節省空間省略) ... */ }
            controlBtn.addEventListener('click', () => {
                if (isRecognizing) { isManualStop = true; recognition.stop();
                } else {
                    isManualStop = false;
                    startAudioMeter().then(() => {
                        recognition.lang = languageSelector.value; startTime = new Date(); transcriptSegments = [];
                        transcriptSegments.push({ id: Date.now(), timestamp: startTime, text: '--- Recording Start / 錄音開始 ---' });
                        updateTranscriptDisplay(); recognition.start();
                    }).catch(err => console.error("Could not start audio meter:", err));
                }
            });
            exportBtn.addEventListener('click', () => { /* ... (內容與之前相同，為節省空間省略) ... */ });
        } else { alert(translations.en.apiNotSupportedError); }

        // --- Utility Functions ---
        function formatTime(date) { /* ... (內容與之前相同，為節省空間省略) ... */ }
        async function startAudioMeter() { /* ... (內容與之前相同，為節省空間省略) ... */ }
        function stopAudioMeter() { /* ... (內容與之前相同，為節省空間省略) ... */ }
        function drawVolume() { /* ... (內容與之前相同，為節省空間省略) ... */ }
        function formatTwoDigits(n) { return n < 10 ? '0' + n : n; }
        function createFileName(start, end) { /* ... (內容與之前相同，為節省空間省略) ... */ }

        // --- Initialize UI ---
        document.addEventListener('DOMContentLoaded', () => {
            Object.keys(recognitionLangs).forEach(key => { const option = document.createElement('option'); option.value = key; option.textContent = recognitionLangs[key]; languageSelector.appendChild(option); });
            Object.keys(translationLangs).forEach(key => { const option = document.createElement('option'); option.value = key; option.textContent = translationLangs[key]; targetLangSelector.appendChild(option); });
            const browserLang = navigator.language || navigator.userLanguage;
            setUiLanguage(browserLang.startsWith('zh') ? 'zh' : 'en');
        });

        // --- 為了讓程式碼區塊完整，這裡複製了所有被省略的函式 ---
        const t_en = { pageTitle: "Multilingual Real-time Transcription Tool", mainTitle: "Multilingual Real-time Transcription Tool", langLabel: "Recognize:", startBtn: "Start", stopBtn: "Stop", exportBtn: "Export", toggleUiLangBtn: "中文", placeholder: "Click 'Start' and your transcript will appear here...", micDeniedError: "You have denied microphone access. Please allow it to use this feature.", apiNotSupportedError: "Your browser does not support the Web Speech API. Please use Chrome.", controlBtnTooltipStart: "Click to start voice recognition", controlBtnTooltipStop: "Click to stop voice recognition", exportBtnTooltip: "Export the transcript as a .txt file", exportBtnTooltipDisabled: "Stop recognition to enable export", languageSelectorTooltip: "Select the language to be recognized", uiLangToggleTooltip: "Switch the user interface language", translateLabel: "Translate:", targetLangLabel: "To:", privacySummary: "Usage Guide & Privacy Notice", privacyContent: `<p>To convert speech to text, this tool sends your voice data to Google's servers. <strong>If translation is enabled, the finalized text transcript will ALSO be sent to Google's translation servers.</strong> Please be aware of the following:</p><h3>Suitable Scenarios:</h3><ul><li class="safe">Assisting in listening to public online lectures.</li><li class="safe">Transcribing public content like videos.</li><li class="safe">Personal language practice.</li></ul><h3>High-Risk Scenarios (DO NOT USE):</h3><ul><li class="unsafe">Meetings involving <strong>business secrets</strong>.</li><li class="unsafe">Conversations involving <strong>personal privacy</strong>.</li><li class="unsafe">Any content containing <strong>sensitive personal data</strong>.</li></ul><p>For sensitive content, it is strongly recommended to use offline tools like Whisper.</p>` };
        const t_zh = { pageTitle: "多國語言即時逐字稿工具", mainTitle: "多國語言即時逐字稿工具", langLabel: "辨識語言:", startBtn: "開始", stopBtn: "停止", exportBtn: "輸出", toggleUiLangBtn: "English", placeholder: "點擊「開始」後，你的逐字稿將會顯示在這裡...", micDeniedError: "您拒絕了麥克風權限，請允許後再使用。", apiNotSupportedError: "您的瀏覽器不支援 Web Speech API，請使用最新版 Chrome。", controlBtnTooltipStart: "點擊以開始語音辨識", controlBtnTooltipStop: "點擊以停止語音辨識", exportBtnTooltip: "將逐字稿匯出為 .txt 檔案", exportBtnTooltipDisabled: "停止辨識後才能匯出", languageSelectorTooltip: "選擇要進行辨識的語言", uiLangToggleTooltip: "切換使用者介面語言", translateLabel: "啟用翻譯:", targetLangLabel: "翻譯目標:", privacySummary: "使用須知 & 隱私聲明", privacyContent: `<p>本工具透過瀏覽器內建 API 進行語音轉文字，這會將您的聲音資料傳送到 Google 的伺服器處理。<strong>若啟用翻譯，最終的逐字稿「文字」也將會被傳送到 Google 的翻譯伺服器。</strong>請務必了解：</p><h3>適合的使用場景：</h3><ul><li class="safe">輔助聆聽公開的線上演講、課程。</li><li class="safe">轉錄影片、Podcast 等公開內容。</li><li class="safe">個人學習、語言練習。</li></ul><h3>高風險場景 (絕對不要使用)：</h3><ul><li class="unsafe">任何涉及<strong>商業機密</strong>的會議。</li><li class="unsafe">任何涉及<strong>個人隱私</strong>的對話。</li><li class="unsafe">任何包含<strong>敏感個資</strong>的內容。</li></ul><p>針對敏感內容，強烈建議使用像 Whisper 這樣完全在您本機離線運作的工具。</p>` };
        Object.assign(translations, { en: t_en, zh: t_zh });
        function setUiLanguage(lang) { currentUiLang = lang; const t = translations[lang]; pageTitle.textContent = t.pageTitle; mainTitle.textContent = t.mainTitle; langLabel.textContent = t.langLabel; exportBtn.textContent = t.exportBtn; uiLangToggle.textContent = t.toggleUiLangBtn; placeholderText.textContent = t.placeholder; uiLangToggle.title = t.uiLangToggleTooltip; languageSelector.title = t.languageSelectorTooltip; translateLabel.textContent = t.translateLabel; targetLangLabel.textContent = t.targetLangLabel; privacySummary.textContent = t.privacySummary; privacyContent.innerHTML = t.privacyContent; updateButtonStates(); }
        function updateButtonStates() { const t = translations[currentUiLang]; controlBtn.textContent = isRecognizing ? t.stopBtn : t.startBtn; controlBtn.title = isRecognizing ? t.controlBtnTooltipStop : t.controlBtnTooltipStart; const canExport = !isRecognizing && transcriptSegments.length > 1; exportBtn.disabled = !canExport; exportBtn.title = canExport ? t.exportBtnTooltip : t.exportBtnTooltipDisabled; }
        recognition.onresult = async (event) => { let interim_transcript = ''; for (let i = event.resultIndex; i < event.results.length; ++i) { const transcript = event.results[i][0].transcript; if (event.results[i].isFinal) { if (transcript.trim()) { const segmentId = Date.now(); transcriptSegments.push({ id: segmentId, timestamp: new Date(), text: transcript.trim() }); updateTranscriptDisplay(); if (translateCheckbox.checked && SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') { translateText(transcript.trim(), segmentId).catch(err => console.error("Translation failed:", err)); } } } else { interim_transcript += transcript; } } const interimSpan = document.getElementById('interim-span'); if(interimSpan) interimSpan.textContent = interim_transcript; };
        async function translateText(text, segmentId) { const sourceLang = languageSelector.value.split('-')[0]; const targetLang = targetLangSelector.value; if (sourceLang === targetLang.split('-')[0]) return; const url = `${SCRIPT_URL}?text=${encodeURIComponent(text)}&source=${sourceLang}&target=${targetLang}`; const response = await fetch(url); const data = await response.json(); if (data.translatedText) { const segment = transcriptSegments.find(s => s.id === segmentId); if (segment) { segment.translation = data.translatedText; updateTranscriptDisplay(); } } else { console.error("Translation API Error:", data.error); } }
        function updateTranscriptDisplay() { let html = ''; transcriptSegments.forEach(segment => { html += `<div class="segment"><span class="original">${formatTime(segment.timestamp)} ${segment.text}</span>`; if (segment.translation) { html += `<span class="translation">${segment.translation}</span>`; } html += `</div>`; }); html += `<span id="interim-span" class="interim"></span>`; transcriptElement.innerHTML = html; transcriptContainer.scrollTop = transcriptContainer.scrollHeight; }
        exportBtn.addEventListener('click', () => { if (!startTime || !endTime) return; let textToSave = ''; transcriptSegments.forEach(s => { textToSave += `${formatTime(s.timestamp)} ${s.text}\r\n`; if(s.translation){ textToSave += `  -> ${s.translation}\r\n`; } textToSave += `\r\n`; }); const fileName = createFileName(startTime, endTime); const blob = new Blob([textToSave], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; a.click(); URL.revokeObjectURL(url); });
        function formatTime(date) { const h = formatTwoDigits(date.getHours()), m = formatTwoDigits(date.getMinutes()), s = formatTwoDigits(date.getSeconds()); return `[${h}:${m}:${s}]`; }
        async function startAudioMeter() { if (!navigator.mediaDevices?.getUserMedia) return Promise.reject('getUserMedia not supported'); microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true }); audioContext = new (window.AudioContext || window.webkitAudioContext)(); analyser = audioContext.createAnalyser(); const source = audioContext.createMediaStreamSource(microphoneStream); source.connect(analyser); drawVolume(); }
        function stopAudioMeter() { if (animationFrameId) cancelAnimationFrame(animationFrameId); microphoneStream?.getTracks().forEach(track => track.stop()); if (audioContext?.state !== 'closed') audio-Context.close(); volumeLevel.style.width = '0%'; }
        function drawVolume() { const dataArray = new Uint8Array(analyser.frequencyBinCount); analyser.getByteTimeDomainData(dataArray); let sumSquares = 0.0; for (const amplitude of dataArray) { const a = (amplitude / 128.0) - 1.0; sumSquares += a * a; } const rms = Math.sqrt(sumSquares / dataArray.length); const volume = Math.min(100, rms * 100 * 10); volumeLevel.style.width = volume + '%'; animationFrameId = requestAnimationFrame(drawVolume); }
        function formatTwoDigits(n) { return n < 10 ? '0' + n : n; }
        function createFileName(start, end) { const date = `${start.getFullYear()}-${formatTwoDigits(start.getMonth() + 1)}-${formatTwoDigits(start.getDate())}`; const startTimeStr = `${formatTwoDigits(start.getHours())}-${formatTwoDigits(start.getMinutes())}`; const endTimeStr = `${formatTwoDigits(end.getHours())}-${formatTwoDigits(end.getMinutes())}`; return `${date}_${startTimeStr}_to_${endTimeStr}.txt`; }
    </script>
</body>
</html>
